/*! For license information please see commands.js.LICENSE.txt */
!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?e(Object(a),!0).forEach((function(e){n(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function n(e,t,n){return(t=l(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return a(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,c=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw c}}}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function c(){"use strict";c=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",u=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function d(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(e){d=function(e,t,n){return e[t]=n}}function p(e,t,n,r){var o=t&&t.prototype instanceof g?t:g,c=Object.create(o.prototype),i=new _(r||[]);return a(c,"_invoke",{value:j(e,n,i)}),c}function h(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=p;var f="suspendedStart",m="suspendedYield",y="executing",v="completed",b={};function g(){}function w(){}function x(){}var E={};d(E,s,(function(){return this}));var k=Object.getPrototypeOf,O=k&&k(k(C([])));O&&O!==n&&r.call(O,s)&&(E=O);var S=x.prototype=g.prototype=Object.create(E);function I(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function L(e,t){function n(a,c,i,s){var u=h(e[a],e,c);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==o(d)&&r.call(d,"__await")?t.resolve(d.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(d).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(u.arg)}var c;a(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,a){n(e,r,t,a)}))}return c=c?c.then(a,a):a()}})}function j(t,n,r){var a=f;return function(o,c){if(a===y)throw Error("Generator is already running");if(a===v){if("throw"===o)throw c;return{value:e,done:!0}}for(r.method=o,r.arg=c;;){var i=r.delegate;if(i){var s=T(i,r);if(s){if(s===b)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===f)throw a=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=y;var u=h(t,n,r);if("normal"===u.type){if(a=r.done?v:m,u.arg===b)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(a=v,r.method="throw",r.arg=u.arg)}}}function T(t,n){var r=n.method,a=t.iterator[r];if(a===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,T(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),b;var o=h(a,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,b;var c=o.arg;return c?c.done?(n[t.resultName]=c.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,b):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,b)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function C(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,c=function n(){for(;++a<t.length;)if(r.call(t,a))return n.value=t[a],n.done=!1,n;return n.value=e,n.done=!0,n};return c.next=c}}throw new TypeError(o(t)+" is not iterable")}return w.prototype=x,a(S,"constructor",{value:x,configurable:!0}),a(x,"constructor",{value:w,configurable:!0}),w.displayName=d(x,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,d(e,l,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},I(L.prototype),d(L.prototype,u,(function(){return this})),t.AsyncIterator=L,t.async=function(e,n,r,a,o){void 0===o&&(o=Promise);var c=new L(p(e,n,r,a),o);return t.isGeneratorFunction(n)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},I(S),d(S,l,"Generator"),d(S,s,(function(){return this})),d(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=C,_.prototype={constructor:_,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function a(r,a){return i.type="throw",i.arg=t,n.next=r,a&&(n.method="next",n.arg=e),!!a}for(var o=this.tryEntries.length-1;o>=0;--o){var c=this.tryEntries[o],i=c.completion;if("root"===c.tryLoc)return a("end");if(c.tryLoc<=this.prev){var s=r.call(c,"catchLoc"),u=r.call(c,"finallyLoc");if(s&&u){if(this.prev<c.catchLoc)return a(c.catchLoc,!0);if(this.prev<c.finallyLoc)return a(c.finallyLoc)}else if(s){if(this.prev<c.catchLoc)return a(c.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return a(c.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var c=o?o.completion:{};return c.type=e,c.arg=t,o?(this.method="next",this.next=o.finallyLoc,b):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),b},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),P(n),b}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;P(n)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:C(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),b}},t}function i(e,t,n,r,a,o,c){try{var i=e[o](c),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,a)}function s(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function c(e){i(o,r,a,c,s,"next",e)}function s(e){i(o,r,a,c,s,"throw",e)}c(void 0)}))}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,l(r.key),r)}}function l(e){var t=function(e){if("object"!=o(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=o(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==o(t)?t:t+""}var d=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var t=this.getSettings();this.host=t.odooUrl,this.db=t.database,this.username=t.username,this.password=t.password,this.worker_url="https://royal-pond-be25.lvr-3b7.workers.dev"},t=[{key:"getSettings",value:function(){var e=localStorage.getItem("odooSettings");if(!e)throw new Error("Aucun réglage trouvé. Veuillez configurer l'add-in.");return JSON.parse(e)}},{key:"buildHeaders",value:function(){return{"Content-Type":"application/json","X-Api-Key":this.password}}},{key:"searchPartners",value:(r=s(c().mark((function e(t){var n,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("".concat(this.worker_url,"/search_partners"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,search_criteria:t})});case 3:return n=e.sent,e.next=6,n.json();case 6:if((r=e.sent).success){e.next=9;break}throw new Error(r.error||"Échec de la recherche");case 9:return e.abrupt("return",r.partners);case 12:throw e.prev=12,e.t0=e.catch(0),console.error("Erreur recherche:",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(e){return r.apply(this,arguments)})},{key:"createAttachment",value:(n=s(c().mark((function e(t){var n,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("".concat(this.worker_url,"/create_attachment"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,attachment_data:t})});case 3:return n=e.sent,e.next=6,n.json();case 6:if((r=e.sent).success){e.next=9;break}throw new Error(r.error||"Échec création pièce jointe");case 9:return e.abrupt("return",r);case 12:throw e.prev=12,e.t0=e.catch(0),console.error("Erreur création pièce jointe:",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(e){return n.apply(this,arguments)})}],t&&u(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r}();function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=document.createElement("div");n.className="notification ".concat(t),n.textContent=e,n.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 15px;\n      background: white;\n      border-radius: 4px;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n      z-index: 1000;\n      border-left: 4px solid ".concat("error"===t?"#f44336":"#4CAF50",";\n  "),document.body.appendChild(n),setTimeout((function(){return n.remove()}),5e3)}function h(){return(h=s(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,m();case 3:w(),e.next=10;break;case 6:e.prev=6,e.t0=e.catch(0),console.error("Erreur initialisation:",e.t0),p("Erreur lors de l'initialisation","error");case 10:case"end":return e.stop()}}),e,null,[[0,6]])})))).apply(this,arguments)}Office.onReady((function(e){e.host===Office.HostType.Outlook&&function(){h.apply(this,arguments)}()}));var f=document.createElement("style");function m(){return y.apply(this,arguments)}function y(){return y=s(c().mark((function e(){var t,n,r,a,o,i,u,l,d,h,f;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=Office.context.mailbox.item){e.next=3;break}return e.abrupt("return");case 3:if(e.prev=3,t.sender&&(n=t.sender.emailAddress,r=t.sender.displayName,n=n.replace(/<mailto:|>/g,"").trim().split(" ")[0],r=r||n.split("@")[0],a=document.getElementById("search-name"),o=document.getElementById("search-sender-email"),i=document.getElementById("search-name-radio"),a&&(a.value=r,a.disabled=!1),o&&(o.value=n,o.disabled=!0),i&&(i.checked=!0),(u=document.getElementById("search-contact-btn"))&&(u.disabled=!1)),!t.attachments){e.next=9;break}return e.next=8,Promise.all(t.attachments.filter((function(e){return!e.isInline})).map(function(){var e=s(c().mark((function e(t){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,g(t.id);case 2:return n=e.sent,e.abrupt("return",{name:t.name,datas:n,mimetype:t.contentType||"application/octet-stream",type:"binary"});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:window.attachmentsToUpload=e.sent;case 9:return e.next=11,new Promise((function(e,n){t.body.getAsync(Office.CoercionType.Text,(function(t){t.status===Office.AsyncResultStatus.Succeeded?e(t.value):n(new Error("Échec chargement message"))}))}));case 11:l=e.sent,d=v(l),h=document.getElementById("search-phone-number"),f=document.getElementById("search-phone-select"),h&&(h.disabled=!0),f&&(f.disabled=!0),b(d),e.next=25;break;case 20:throw e.prev=20,e.t0=e.catch(3),console.error("Erreur chargement données:",e.t0),p("Erreur lors du chargement des données","error"),e.t0;case 25:case"end":return e.stop()}}),e,null,[[3,20]])}))),y.apply(this,arguments)}function v(e){function t(e){return(e.match(/\d/g)||[]).length}function n(e){if(t(e)<6)return null;var n=e.trim().replace(/[\(\)]/g,"").replace(/[\/\s.-]+/g," ").replace(/\s+/g," ").trim();return n.startsWith("0")?n="+32"+n.substring(1):n.startsWith("00")&&(n="+"+n.substring(2)),{formatted:n,digitCount:t(n)}}for(var a=new Map,o=0,c=[/(?:\+|00)[1-9]\d{1,3}[- .]?\d(?:[- .]?\d){4,14}/g,/(?:0[1-9]|04\d{1,2})[/\s.-]?\d{2,3}[/\s.-]?\d{2,3}[/\s.-]?\d{2,3}/g,/\d{3,4}[/\s.-]?\d{2,3}[/\s.-]?\d{2,3}[/\s.-]?\d{2,3}/g];o<c.length;o++){var i,s=c[o],u=r(e.matchAll(s));try{for(u.s();!(i=u.n()).done;){var l=n(i.value[0]);l&&l.digitCount>=6&&(a.has(l.formatted)||a.set(l.formatted,l))}}catch(e){u.e(e)}finally{u.f()}}return Array.from(a.values())}function b(e){for(var t=document.getElementById("search-phone-select"),n=document.getElementById("search-phone-number");t.options.length>1;)t.remove(1);e.forEach((function(e,n){var r=document.createElement("option");r.value=e.formatted,r.textContent="Numéro ".concat(n+1,": ").concat(e.formatted),t.appendChild(r)})),e.length>0&&(n.value=e[0].formatted)}function g(e){return new Promise((function(t,n){Office.context.mailbox.item.getAttachmentContentAsync(e,(function(e){e.status===Office.AsyncResultStatus.Succeeded?t(e.value.content):n(new Error("Échec récupération pièce jointe"))}))}))}function w(){var e=document.querySelectorAll('input[name="search-type"]'),t=document.getElementById("search-contact-btn");if(t){e.forEach((function(e){e.addEventListener("change",(function(){switch(document.getElementById("search-name").disabled=!0,document.getElementById("search-sender-email").disabled=!0,document.getElementById("search-phone-number").disabled=!0,document.getElementById("search-phone-select").disabled=!0,this.value){case"name":document.getElementById("search-name").disabled=!1;break;case"email":document.getElementById("search-sender-email").disabled=!1;break;case"phone":document.getElementById("search-phone-number").disabled=!1,document.getElementById("search-phone-select").disabled=!1}}))}));var n=document.getElementById("search-phone-select");n&&n.addEventListener("change",(function(e){var t=document.getElementById("search-phone-number");t&&e.target.value&&(t.value=e.target.value)})),t&&t.addEventListener("click",x)}else console.error("Bouton de recherche non trouvé")}function x(){return E.apply(this,arguments)}function E(){return(E=s(c().mark((function e(){var t,n,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("search-contact-btn"),document.getElementById("search-results"),e.prev=2,t.disabled=!0,t.innerHTML='<i class="ms-Icon ms-Icon--Search"></i>Recherche en cours...',n=k()){e.next=9;break}return p("Veuillez sélectionner au moins un critère de recherche","error"),e.abrupt("return");case 9:return r=new d,e.next=12,r.searchPartners(n);case 12:O(e.sent,r.host),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(2),console.error("Erreur recherche:",e.t0),p(e.t0.message,"error");case 20:return e.prev=20,t.disabled=!1,t.innerHTML='<i class="ms-Icon ms-Icon--Search"></i>Chercher le contact',e.finish(20);case 24:case"end":return e.stop()}}),e,null,[[2,16,20,24]])})))).apply(this,arguments)}function k(){var e=document.querySelector('input[name="search-type"]:checked');if(!e)return null;var t,n={};switch(e.value){case"phone":t="search-phone-number";break;case"email":t="search-sender-email";break;case"name":t="search-name";break;default:return null}var r=document.getElementById(t);if(!r)return console.error("Champ ".concat(t," non trouvé")),null;var a=r.value.trim();return a&&("phone"===e.value?n.phone=a.replace(/[^0-9+]/g,""):n[e.value]=a),Object.keys(n).length>0?n:null}function O(e,t){var n=document.getElementById("search-results");if(n.innerHTML="",0!==e.length){var r=document.createElement("div");r.className="partner-cards",e.forEach((function(e){var n=function(e,t){var n=document.createElement("div");return n.className="partner-card",n.dataset.partnerId=e.id,n.innerHTML='\n      <div class="card-header">\n          <input type="radio" name="partner-select" class="partner-select" data-partner-id="'.concat(e.id,'">\n          <h3 class="partner-name">').concat(e.name,'</h3>\n      </div>\n      <div class="card-content">\n          <p class="partner-street">').concat(e.street||"",'</p>\n          <p class="partner-city">').concat(e.zip||""," ").concat(e.city||"",'</p>\n      </div>\n      <div class="card-footer">\n          <a href="').concat(t,"/web#id=").concat(e.id,'&model=res.partner&view_type=form" \n             target="_blank" class="view-button">\n             Voir dans Odoo\n          </a>\n          <button class="upload-button" style="display: none;" data-partner-id="').concat(e.id,'">\n              <i class="ms-Icon ms-Icon--Upload"></i> Upload sélection\n          </button>\n      </div>\n      <div class="attachment-section" style="display: none;">\n          <h4>Pièces jointes disponibles</h4>\n          <div class="attachment-list"></div>\n      </div>\n  '),n}(e,t);r.appendChild(n)})),n.appendChild(r),document.querySelectorAll(".partner-select").forEach((function(e){e.addEventListener("change",s(c().mark((function e(){var t,n,r,a,o,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.closest(".partner-card"),this.dataset.partnerId,!this.checked){e.next=13;break}return document.querySelectorAll(".partner-card").forEach((function(e){e!==t&&(e.style.display="none")})),n=t.querySelector(".attachment-section"),r=t.querySelector(".attachment-list"),a=t.querySelector(".upload-button"),n.style.display="block",a.style.display="block",e.next=11,S(r);case 11:e.next=18;break;case 13:document.querySelectorAll(".partner-card").forEach((function(e){e.style.display="block"})),o=t.querySelector(".attachment-section"),i=t.querySelector(".upload-button"),o.style.display="none",i.style.display="none";case 18:case"end":return e.stop()}}),e,this)})))),e.addEventListener("click",(function(e){this.checked&&"true"===this.dataset.wasChecked&&(this.checked=!1,this.dispatchEvent(new Event("change"))),this.dataset.wasChecked=this.checked}))})),document.querySelectorAll(".upload-button").forEach((function(e){e.addEventListener("click",T)}))}else n.innerHTML='<div class="no-results">Aucun contact trouvé</div>'}function S(e){return I.apply(this,arguments)}function I(){return(I=s(c().mark((function e(t){var n,a,o,i,s,u,l,d,p,h,f,m,y,v,b,w,x;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.innerHTML="",console.log("Début du chargement des pièces jointes"),n=Office.context.mailbox.item,window.attachmentsToUpload=[],a=0,!n.attachments){e.next=35;break}o=n.attachments.filter((function(e){return!e.isInline||e.contentType&&e.contentType.startsWith("image/")})),i=r(o),e.prev=8,i.s();case 10:if((s=i.n()).done){e.next=27;break}return u=s.value,e.prev=12,e.next=15,g(u.id);case 15:l=e.sent,d=void 0,u.isInline&&u.contentType.startsWith("image/")?(d=L("data:".concat(u.contentType,";base64,").concat(l),a,u.name),window.attachmentsToUpload[a]={name:u.name,datas:l,mimetype:u.contentType,type:"binary",isInline:!0}):(p={name:u.name,datas:l,mimetype:u.contentType||"application/octet-stream",type:"binary"},d=j(p,a),window.attachmentsToUpload[a]=p),t.appendChild(d),a++,e.next=25;break;case 22:e.prev=22,e.t0=e.catch(12),console.error("Erreur chargement pièce jointe ".concat(u.name,":"),e.t0);case 25:e.next=10;break;case 27:e.next=32;break;case 29:e.prev=29,e.t1=e.catch(8),i.e(e.t1);case 32:return e.prev=32,i.f(),e.finish(32);case 35:return e.prev=35,e.next=38,new Promise((function(e,t){n.body.getAsync(Office.CoercionType.Html,{asyncContext:"This is passed to the callback"},(function(n){n.status===Office.AsyncResultStatus.Succeeded?e(n.value):t(new Error("Échec chargement HTML"))}))}));case 38:h=e.sent,(f=document.createElement("div")).innerHTML=h,m=Array.from(f.getElementsByTagName("img")).filter((function(e){var t=e.src||e.getAttribute("src");return t&&!t.startsWith("cid:")&&!t.startsWith("data:")&&!t.includes("outlook.office365.com")&&!t.includes("outlook.office.com")})),y=r(m);try{for(y.s();!(v=y.n()).done;)b=v.value,(w=b.src||b.getAttribute("src"))&&(x=L(w,a,"Image ".concat(a+1)),t.appendChild(x),window.attachmentsToUpload[a]={name:"Image ".concat(a+1,".png"),src:w,type:"image",mimetype:"image/png"},a++)}catch(e){y.e(e)}finally{y.f()}e.next=49;break;case 46:e.prev=46,e.t2=e.catch(35),console.error("Erreur chargement images:",e.t2);case 49:case"end":return e.stop()}}),e,null,[[8,29,32,35],[12,22],[35,46]])})))).apply(this,arguments)}function L(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=document.createElement("div");r.className="attachment-item";var a=n||"Image ".concat(t+1);return r.innerHTML='\n      <input type="checkbox" id="image-'.concat(t,'" data-type="image" data-src="').concat(e,'">\n      <img src="').concat(e,'" class="image-preview" alt="Preview" onerror="this.style.display=\'none\'">\n      <label for="image-').concat(t,'">\n          ').concat(a,'\n          <br>\n          <small class="image-source">').concat(e.startsWith("data:")?"Image intégrée":e.substring(0,50)+"...","</small>\n      </label>\n  "),r}function j(e,t){var n=document.createElement("div");n.className="attachment-item";var r=document.createElement("style");return r.textContent='\n      .attachment-item {\n          display: flex;\n          align-items: center;\n          padding: 10px;\n          border: 1px solid #ddd;\n          margin-bottom: 5px;\n          border-radius: 4px;\n      }\n      .attachment-item:hover {\n          background-color: #f5f5f5;\n      }\n      .file-type {\n          color: #666;\n          font-size: 0.8em;\n          margin-left: 5px;\n      }\n      .attachment-item label {\n          cursor: pointer;\n          flex: 1;\n      }\n      .attachment-item input[type="checkbox"] {\n          margin-right: 10px;\n      }\n  ',document.head.appendChild(r),n.innerHTML='\n      <input type="checkbox" id="attachment-'.concat(t,'" data-type="file">\n      <label for="attachment-').concat(t,'">\n          ').concat(e.name,'\n          <span class="file-type">(').concat(e.mimetype,")</span>\n      </label>\n  "),n}function T(){return A.apply(this,arguments)}function A(){return(A=s(c().mark((function e(){var n,a,o,i,s,u,l,h,f,m,y,v;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.dataset.partnerId,a=this.innerHTML,o=this.closest(".partner-card"),e.prev=3,this.disabled=!0,this.innerHTML='<i class="ms-Icon ms-Icon--Sync"></i> Upload en cours...',0!==(i=o.querySelectorAll('.attachment-item input[type="checkbox"]:checked')).length){e.next=10;break}return p("Veuillez sélectionner au moins une pièce jointe","error"),e.abrupt("return");case 10:s=new d,u=r(i),e.prev=12,u.s();case 14:if((l=u.n()).done){e.next=34;break}if(h=l.value,f=parseInt(h.id.split("-")[1]),m=window.attachmentsToUpload[f]){e.next=21;break}return console.error("Pièce jointe non trouvée pour l'index ".concat(f)),e.abrupt("continue",32);case 21:if(y=void 0,"image"!==m.type||!m.src){e.next=29;break}return e.next=25,P(m.src);case 25:v=e.sent,y={name:m.name,datas:v,mimetype:m.mimetype,type:"binary",res_model:"res.partner",res_id:parseInt(n)},e.next=30;break;case 29:y=t(t({},m),{},{res_model:"res.partner",res_id:parseInt(n)});case 30:return e.next=32,s.createAttachment(y);case 32:e.next=14;break;case 34:e.next=39;break;case 36:e.prev=36,e.t0=e.catch(12),u.e(e.t0);case 39:return e.prev=39,u.f(),e.finish(39);case 42:p("Pièces jointes uploadées avec succès","success"),o.querySelector(".partner-select").checked=!1,o.querySelector(".attachment-section").style.display="none",this.style.display="none",document.querySelectorAll(".partner-card").forEach((function(e){e.style.display="block"})),e.next=53;break;case 49:e.prev=49,e.t1=e.catch(3),console.error("Erreur upload:",e.t1),p("Erreur lors de l'upload des pièces jointes","error");case 53:return e.prev=53,this.disabled=!1,this.innerHTML=a,e.finish(53);case 57:case"end":return e.stop()}}),e,this,[[3,49,53,57],[12,36,39,42]])})))).apply(this,arguments)}function P(e){return _.apply(this,arguments)}function _(){return(_=s(c().mark((function e(t){var n,r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(t);case 2:return n=e.sent,e.next=5,n.blob();case 5:return r=e.sent,e.abrupt("return",new Promise((function(e,t){var n=new FileReader;n.onloadend=function(){return e(n.result.split(",")[1])},n.onerror=t,n.readAsDataURL(r)})));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}f.textContent="\n    .partner-cards {\n        display: grid;\n        gap: 1rem;\n    }\n    \n    .partner-card {\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        background: white;\n    }\n\n    .card-header {\n        display: flex;\n        align-items: center;\n        gap: 1rem;\n        margin-bottom: 0.5rem;\n    }\n\n    .partner-name {\n        margin: 0;\n        font-size: 1.1em;\n        font-weight: 600;\n    }\n\n    .card-content {\n        color: #666;\n        font-size: 0.9em;\n    }\n\n    .card-footer {\n        display: flex;\n        justify-content: space-between;\n        margin-top: 1rem;\n    }\n\n    .view-button, .upload-button {\n        padding: 0.5rem 1rem;\n        border-radius: 4px;\n        border: none;\n        cursor: pointer;\n        text-decoration: none;\n        color: white;\n        background: #007bff;\n    }\n\n    .upload-button {\n        background: #28a745;\n    }\n\n    .notification {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        padding: 1rem;\n        border-radius: 4px;\n        background: white;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n        z-index: 1000;\n    }\n",document.head.appendChild(f)}();
//# sourceMappingURL=commands.js.map