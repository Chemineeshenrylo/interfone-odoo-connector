/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={58394:function(e,t,n){"use strict";e.exports=n.p+"d67abbd1b29f8152d5a1.css"}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}n.m=e,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var a=r.length-1;a>-1&&(!e||!/^http(s?):/.test(e));)e=r[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e}(),n.b=document.baseURI||self.location.href,function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(){"use strict";t=function(){return r};var n,r={},a=Object.prototype,o=a.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},c=s.iterator||"@@iterator",u=s.asyncIterator||"@@asyncIterator",l=s.toStringTag||"@@toStringTag";function d(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(n){d=function(e,t,n){return e[t]=n}}function p(e,t,n,r){var a=t&&t.prototype instanceof b?t:b,o=Object.create(a.prototype),s=new B(r||[]);return i(o,"_invoke",{value:j(e,n,s)}),o}function m(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}r.wrap=p;var h="suspendedStart",f="suspendedYield",v="executing",g="completed",y={};function b(){}function w(){}function x(){}var E={};d(E,c,(function(){return this}));var k=Object.getPrototypeOf,I=k&&k(k(P([])));I&&I!==a&&o.call(I,c)&&(E=I);var S=x.prototype=b.prototype=Object.create(E);function O(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function T(t,n){function r(a,i,s,c){var u=m(t[a],t,i);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==e(d)&&o.call(d,"__await")?n.resolve(d.__await).then((function(e){r("next",e,s,c)}),(function(e){r("throw",e,s,c)})):n.resolve(d).then((function(e){l.value=e,s(l)}),(function(e){return r("throw",e,s,c)}))}c(u.arg)}var a;i(this,"_invoke",{value:function(e,t){function o(){return new n((function(n,a){r(e,t,n,a)}))}return a=a?a.then(o,o):o()}})}function j(e,t,r){var a=h;return function(o,i){if(a===v)throw Error("Generator is already running");if(a===g){if("throw"===o)throw i;return{value:n,done:!0}}for(r.method=o,r.arg=i;;){var s=r.delegate;if(s){var c=L(s,r);if(c){if(c===y)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===h)throw a=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=v;var u=m(e,t,r);if("normal"===u.type){if(a=r.done?g:f,u.arg===y)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(a=g,r.method="throw",r.arg=u.arg)}}}function L(e,t){var r=t.method,a=e.iterator[r];if(a===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=n,L(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var o=m(a,e.iterator,t.arg);if("throw"===o.type)return t.method="throw",t.arg=o.arg,t.delegate=null,y;var i=o.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=n),t.delegate=null,y):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,y)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function _(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function B(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function P(t){if(t||""===t){var r=t[c];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,i=function e(){for(;++a<t.length;)if(o.call(t,a))return e.value=t[a],e.done=!1,e;return e.value=n,e.done=!0,e};return i.next=i}}throw new TypeError(e(t)+" is not iterable")}return w.prototype=x,i(S,"constructor",{value:x,configurable:!0}),i(x,"constructor",{value:w,configurable:!0}),w.displayName=d(x,l,"GeneratorFunction"),r.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},r.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,d(e,l,"GeneratorFunction")),e.prototype=Object.create(S),e},r.awrap=function(e){return{__await:e}},O(T.prototype),d(T.prototype,u,(function(){return this})),r.AsyncIterator=T,r.async=function(e,t,n,a,o){void 0===o&&(o=Promise);var i=new T(p(e,t,n,a),o);return r.isGeneratorFunction(t)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},O(S),d(S,l,"Generator"),d(S,c,(function(){return this})),d(S,"toString",(function(){return"[object Generator]"})),r.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},r.values=P,B.prototype={constructor:B,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(_),!e)for(var t in this)"t"===t.charAt(0)&&o.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,a){return s.type="throw",s.arg=e,t.next=r,a&&(t.method="next",t.arg=n),!!a}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var c=o.call(i,"catchLoc"),u=o.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),_(n),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;_(n)}return a}}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:P(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=n),y}},r}function n(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(a,o){var i=e.apply(t,r);function s(e){n(i,a,o,s,c,"next",e)}function c(e){n(i,a,o,s,c,"throw",e)}s(void 0)}))}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,c(r.key),r)}}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t,n){return(t=c(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}function u(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function d(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=(new Date).toISOString(),r="[".concat(n,"] ").concat(e);t?(console.group(r),console.log("Détails:",t),t instanceof Error&&console.log("Stack:",t.stack),console.groupEnd()):console.log(r)}Office.onReady((function(e){var t,n;d("Office.onReady appelé",e),e.host===Office.HostType.Outlook&&(d("Application démarrée dans Outlook"),document.getElementById("sideload-msg").style.display="none",document.getElementById("app-body").style.display="block",function(){d("Chargement des données de l'email");var e,t,n=Office.context.mailbox.item;if(n){if(t=document.getElementById("phone-number"),document.getElementById("phone-select").addEventListener("change",(function(e){e.target.value&&(t.value=e.target.value)})),t.addEventListener("input",(function(e){var t=e.target.value;t=t.replace(/[^\d+\s]/g,""),e.target.value=t})),n.attachments&&n.attachments.length>0){d("Nombre de pièces jointes trouvées:",n.attachments.length);var r=n.attachments.filter((function(e){return!e.isInline})).map((function(e){return{name:e.name,size:e.size,contentType:e.contentType,id:e.id}}));m(r),window.attachmentsToUpload=[],r.forEach((function(e){Office.context.mailbox.item.getAttachmentContentAsync(e.id,(function(t){if(t.status===Office.AsyncResultStatus.Succeeded){var n=btoa(unescape(encodeURIComponent(t.value.content))),r=i(i({},e),{},{content:n});window.attachmentsToUpload.push(r),d("Pièce jointe récupérée:",{name:e.name,type:e.contentType,size:e.size,id:e.id})}else d("Erreur lors de la récupération de la pièce jointe:",t.error)}))}))}else d("Aucune pièce jointe trouvée"),m([]);if(n.sender){var a=n.sender.emailAddress,o=n.sender.displayName;d("Données brutes de l'expéditeur:",{rawEmail:a,rawName:o}),a=(e=a)?((e=(e=e.replace(/<mailto:/g,"").replace(/>/g,"")).trim()).includes(" ")&&(e=e.split(" ")[0]),e):"",o||(o=a.split("@")[0]),document.getElementById("sender-name").value=o,document.getElementById("sender-email").value=a,d("Informations de l'expéditeur nettoyées:",{email:a,name:o})}var s=n.subject||"";document.getElementById("email-subject").value=s,d("Sujet chargé:",s),n.body.getAsync(Office.CoercionType.Text,(function(e){if(e.status===Office.AsyncResultStatus.Succeeded){var t=e.value;document.getElementById("email-body").value=t;var n=function(e){function t(e){return(e.match(/\d/g)||[]).length}function n(e){if(t(e)<6)return null;var n=e.trim().replace(/[\(\)]/g,"").replace(/[-\.]/g," ").replace(/\s+/g," ");return n.startsWith("00")&&(n="+"+n.slice(2)),{formatted:n,digitCount:t(n)}}for(var r=new Map,a=0,o=[/(?:\+|00)[1-9]\d{1,3}[- .]?\d(?:[- .]?\d){4,14}/g,/\d(?:[- .]?\d){5,14}/g];a<o.length;a++){var i,s=o[a],c=u(e.matchAll(s));try{for(c.s();!(i=c.n()).done;){var l=n(i.value[0]);l&&l.digitCount>=6&&(r.has(l.formatted)||r.set(l.formatted,l))}}catch(e){c.e(e)}finally{c.f()}}return Array.from(r.values())}(t);d("Numéros de téléphone détectés:",n),function(e){for(var t=document.getElementById("phone-select"),n=document.getElementById("phone-number");t.options.length>1;)t.remove(1);e.forEach((function(e,n){var r=document.createElement("option");r.value=e.formatted,r.textContent="Numéro ".concat(n+1,": ").concat(e.formatted),t.appendChild(r)})),e.length>0&&(n.value=e[0].formatted)}(n);var r=function(e){var t,n=new Map,r=u(e.matchAll(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g));try{for(r.s();!(t=r.n()).done;){var a=t.value[0].toLowerCase().trim();if(!n.has(a)){var o=!a.split("@")[1].includes("cheminees");n.set(a,{email:a,isPriority:o})}}}catch(e){r.e(e)}finally{r.f()}return Array.from(n.values()).sort((function(e,t){return e.isPriority!==t.isPriority?e.isPriority?-1:1:e.email.localeCompare(t.email)}))}(t);d("Emails détectés:",r),function(e){for(var t=document.getElementById("email-select"),n=document.getElementById("sender-email");t.options.length>1;)t.remove(1);e.forEach((function(e,n){var r=document.createElement("option");r.value=e.email;var a=e.isPriority?"🔵":"⚪";r.textContent="".concat(a," Email ").concat(n+1,": ").concat(e.email),t.appendChild(r)})),e.length>0&&(n.value=e[0].email)}(r)}else d("Erreur lors de la récupération du corps du message:",e.error)}))}else d("Aucun élément email trouvé")}(),function(){d("Chargement des données de l'utilisateur");var e=Office.context.mailbox.userProfile;if(e){var t=e.emailAddress;document.getElementById("user-email").value=t,d("Email de l'utilisateur chargé:",t)}else d("Profil utilisateur non disponible")}(),function(){d("Chargement des réglages sauvegardés");try{var e=localStorage.getItem("odooSettings");if(e){var t=JSON.parse(e);d("Réglages trouvés",{hasUrl:!!t.odooUrl,hasDatabase:!!t.database,hasUsername:!!t.username,hasPassword:!!t.password}),document.getElementById("odoo-url").value=t.odooUrl||"",document.getElementById("database").value=t.database||"",document.getElementById("username").value=t.username||"",document.getElementById("password").value=t.password||""}else d("Aucun réglage sauvegardé trouvé")}catch(e){d("Erreur lors du chargement des réglages",e)}}(),t=document.getElementById("password"),n=document.getElementById("toggle-password"),t&&n&&n.addEventListener("click",(function(){var e="password"===t.type?"text":"password";t.type=e;var r=n.querySelector("i");"password"===e?r.classList.replace("ms-Icon--Hide","ms-Icon--RedEye"):r.classList.replace("ms-Icon--RedEye","ms-Icon--Hide")})),function(){var e=["sender-email","email-subject"],t=document.getElementById("save-to-crm");function n(){var n=e.every((function(e){var t=document.getElementById(e);return t&&""!==t.value.trim()}));t.disabled=!n}e.forEach((function(e){var t=document.getElementById(e);t&&(t.addEventListener("input",n),t.addEventListener("change",n))})),n()}())}));var p=document.createElement("style");function m(e){var t=document.getElementById("attachments-list");if(t)if(t.innerHTML="",e&&0!==e.length){var n=document.createElement("ul");n.className="attachments-list",e.forEach((function(e,t){var r=document.createElement("li");r.className="attachment-item";var a=function(e){if(0===e)return"0 B";var t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}(e.size);r.innerHTML='\n            <div class="attachment-info">\n                <span class="attachment-name">'.concat(e.name,'</span>\n                <span class="attachment-size">').concat(a,"</span>\n            </div>\n        "),n.appendChild(r)})),t.appendChild(n);var r=document.createElement("style");r.textContent="\n        .attachments-list {\n            list-style: none;\n            padding: 0;\n            margin: 0;\n        }\n        \n        .attachment-item {\n            padding: 8px;\n            border: 1px solid #ddd;\n            margin-bottom: 8px;\n            border-radius: 4px;\n            background-color: #f8f9fa;\n        }\n        \n        .attachment-info {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        \n        .attachment-name {\n            font-weight: 500;\n            color: #333;\n        }\n        \n        .attachment-size {\n            color: #666;\n            font-size: 0.9em;\n        }\n        \n        .no-attachments {\n            color: #666;\n            font-style: italic;\n            text-align: center;\n            padding: 10px;\n        }\n    ",document.head.appendChild(r)}else t.innerHTML='<p class="no-attachments">Aucune pièce jointe</p>'}p.textContent="\n    .phone-input-container {\n        position: relative;\n        display: flex;\n        gap: 8px;\n    }\n    \n    #phone-number {\n        flex: 1;\n        padding: 8px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n    }\n    \n    #phone-select {\n        width: auto;\n        min-width: 120px;\n        padding: 8px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        background-color: #f8f9fa;\n    }\n",document.head.appendChild(p);var h=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var t=this.getSettings();this.host=t.odooUrl,this.db=t.database,this.username=t.username,this.password=t.password,this.worker_url="https://royal-pond-be25.lvr-3b7.workers.dev",this.maxRetries=3,this.retryDelay=1e3,d("OdooAPI initialisée",{host:this.host,database:this.db,username:this.username,worker_url:this.worker_url})},n=[{key:"getSettings",value:function(){var e=localStorage.getItem("odooSettings");if(!e)throw new Error("Aucun réglage trouvé. Veuillez configurer l'add-in dans les paramètres.");var t=JSON.parse(e);if(!(t.odooUrl&&t.database&&t.username&&t.password))throw new Error("Configuration incomplète. Veuillez vérifier vos paramètres.");return t}},{key:"formatOdooUrl",value:function(e){return e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e),e.replace(/\/$/,"")}},{key:"retryRequest",value:(h=r(t().mark((function e(n){var r,a,o,i=this;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t().mark((function e(r){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n();case 3:return e.t0=e.sent,e.abrupt("return",{v:e.t0});case 7:if(e.prev=7,e.t1=e.catch(0),d("Tentative ".concat(r+1,"/").concat(i.maxRetries," échouée"),e.t1),r!==i.maxRetries-1){e.next=12;break}throw e.t1;case 12:return e.next=14,new Promise((function(e){return setTimeout(e,i.retryDelay*(r+1))}));case 14:case"end":return e.stop()}}),e,null,[[0,7]])})),o=0;case 2:if(!(o<this.maxRetries)){e.next=10;break}return e.delegateYield(r(o),"t0",4);case 4:if(!(a=e.t0)){e.next=7;break}return e.abrupt("return",a.v);case 7:o++,e.next=2;break;case 10:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"escapeXml",value:function(e){return"string"!=typeof e?e:e.replace(/[<>&'"]/g,(function(e){switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;";default:return e}})).replace(/[\x00-\x1F\x7F-\x9F]/g,"").trim()}},{key:"createLead",value:(m=r(t().mark((function e(n,r,a){var o,i,s,c,l,p,m,h,f,v,g;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getUserId();case 3:return o=e.sent,i=document.getElementById("sender-name").value.trim(),s=document.getElementById("phone-number").value.trim(),d("Données nettoyées pour création lead:",c={name:this.escapeXml(r||"Nouveau lead"),email_from:this.escapeXml(n),description:this.escapeXml(a),user_id:o,type:"opportunity",active:!0,company_id:1,stage_id:16,contact_name:this.escapeXml(i||n.split("@")[0]),phone:this.escapeXml(s)}),e.next=10,this.fetchWithTimeout("".concat(this.worker_url,"/create_lead"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,lead_data:c})});case 10:return l=e.sent,e.next=13,l.text();case 13:d("Réponse brute création lead:",p=e.sent),e.prev=15,m=JSON.parse(p),e.next=22;break;case 19:throw e.prev=19,e.t0=e.catch(15),new Error("Réponse invalide du serveur: ".concat(p));case 22:if(m.success){e.next=24;break}throw new Error(m.error||"Réponse serveur indique un échec");case 24:if(h=m.lead_id,!(window.attachmentsToUpload&&window.attachmentsToUpload.length>0)){e.next=52;break}d("Début upload des pièces jointes (".concat(window.attachmentsToUpload.length,")")),f=u(window.attachmentsToUpload),e.prev=28,f.s();case 30:if((v=f.n()).done){e.next=43;break}return g=v.value,e.prev=32,e.next=35,this.createAttachment(h,g);case 35:d("Pièce jointe uploadée avec succès:",g.name),e.next=41;break;case 38:e.prev=38,e.t1=e.catch(32),d("Erreur upload pièce jointe:",{name:g.name,error:e.t1.message});case 41:e.next=30;break;case 43:e.next=48;break;case 45:e.prev=45,e.t2=e.catch(28),f.e(e.t2);case 48:return e.prev=48,f.f(),e.finish(48);case 51:window.attachmentsToUpload=[];case 52:return e.abrupt("return",{success:!0,leadId:h,message:"Lead et pièces jointes créés avec succès",details:m});case 55:throw e.prev=55,e.t3=e.catch(0),d("Erreur détaillée création lead:",e.t3),e.t3;case 59:case"end":return e.stop()}}),e,this,[[0,55],[15,19],[28,45,48,51],[32,38]])}))),function(e,t,n){return m.apply(this,arguments)})},{key:"createAttachment",value:(p=r(t().mark((function e(n,r){var a,o,i,s;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getUserId();case 3:return e.sent,a={method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,attachment_data:{name:r.name,datas:r.content,res_model:"crm.lead",res_id:n,type:"binary",mimetype:r.contentType,description:"Pièce jointe provenant d'Outlook"}})},e.next=7,this.fetchWithTimeout("".concat(this.worker_url,"/create_attachment"),a);case 7:return o=e.sent,e.next=10,o.text();case 10:d("Réponse création attachment:",i=e.sent),e.prev=12,s=JSON.parse(i),e.next=19;break;case 16:throw e.prev=16,e.t0=e.catch(12),new Error("Réponse invalide du serveur: ".concat(i));case 19:if(s.success){e.next=21;break}throw new Error(s.error||"Réponse serveur indique un échec");case 21:return e.abrupt("return",s.attachment_id);case 24:throw e.prev=24,e.t1=e.catch(0),d("Erreur création pièce jointe:",e.t1),e.t1;case 28:case"end":return e.stop()}}),e,this,[[0,24],[12,16]])}))),function(e,t){return p.apply(this,arguments)})},{key:"getUserId",value:(l=r(t().mark((function e(){var n,r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.fetchWithTimeout("".concat(this.worker_url,"/get_user_id"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password})});case 3:if((n=e.sent).ok){e.next=6;break}throw new Error("Erreur HTTP ".concat(n.status));case 6:return e.next=8,n.json();case 8:if((r=e.sent).success&&r.user_id){e.next=11;break}throw new Error("Impossible de récupérer l'ID utilisateur");case 11:return e.abrupt("return",r.user_id);case 14:throw e.prev=14,e.t0=e.catch(0),new Error("Erreur lors de la récupération de l'ID utilisateur: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,this,[[0,14]])}))),function(){return l.apply(this,arguments)})},{key:"testServerConnection",value:(c=r(t().mark((function e(){var n=this;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d("Test de connexion au serveur",{url:this.worker_url,odoo_url:this.host}),e.abrupt("return",this.retryRequest(r(t().mark((function e(){var r,a,o,i,s,c;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.fetchWithTimeout("".concat(n.worker_url,"/test"),{method:"POST",headers:n.buildHeaders(),body:JSON.stringify({odoo_url:n.host,database:n.db,username:n.username,password:n.password})});case 3:if((o=e.sent).ok){e.next=9;break}return e.next=7,o.json().catch((function(){return{}}));case 7:throw i=e.sent,new Error(i.error||"Erreur HTTP ".concat(o.status));case 9:return e.next=11,o.json();case 11:if(d("Réponse du test de connexion",s=e.sent),(null===(r=s.details)||void 0===r||null===(r=r.login_response)||void 0===r?void 0:r.includes("<value><int>"))||(null===(a=s.details)||void 0===a||null===(a=a.login_response)||void 0===a?void 0:a.includes("<value><boolean>1</boolean>"))){e.next=16;break}throw new Error("Échec de l'authentification. Vérifiez vos identifiants de connexion.");case 16:return c=n.extractVersionInfo(s.details.version_response),e.abrupt("return",{success:!0,message:"Connexion établie avec succès (Odoo ".concat(c.version,")"),details:{version:c,responses:s.details}});case 20:return e.prev=20,e.t0=e.catch(0),e.abrupt("return",n.handleError(e.t0,"Erreur lors du test de connexion"));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})))));case 2:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"extractVersionInfo",value:function(e){try{var t=e.match(/<name>server_version<\/name>\s*<value><string>(.*?)<\/string><\/value>/),n=t?t[1]:"Version inconnue",r=e.match(/<name>server_serie<\/name>\s*<value><string>(.*?)<\/string><\/value>/);return{version:n,serie:r?r[1]:""}}catch(e){return d("Erreur extraction version",e),{version:"Version inconnue",serie:"Inconnue"}}}},{key:"validateCredentials",value:function(){if(!this.host||!this.db||!this.password)throw new Error("Configuration incomplète: tous les paramètres de connexion sont requis")}},{key:"init",value:(s=r(t().mark((function e(){var n;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.validateCredentials(),this.host=this.formatOdooUrl(this.host),e.next=5,this.testServerConnection();case 5:if((n=e.sent).success){e.next=8;break}throw new Error("Échec de l'initialisation: ".concat(n.message));case 8:return d("Initialisation réussie",n),e.abrupt("return",n);case 12:throw e.prev=12,e.t0=e.catch(0),d("Erreur lors de l'initialisation",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(){return s.apply(this,arguments)})},{key:"buildHeaders",value:function(){return{"Content-Type":"application/json","X-Api-Key":this.password}}},{key:"fetchWithTimeout",value:(o=r(t().mark((function e(n,r){var a,o,s,c,u=arguments;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=u.length>2&&void 0!==u[2]?u[2]:5e3,o=new AbortController,s=setTimeout((function(){return o.abort()}),a),e.prev=3,e.next=6,fetch(n,i(i({},r),{},{signal:o.signal}));case 6:return c=e.sent,clearTimeout(s),e.abrupt("return",c);case 11:throw e.prev=11,e.t0=e.catch(3),clearTimeout(s),e.t0;case 15:case"end":return e.stop()}}),e,null,[[3,11]])}))),function(e,t){return o.apply(this,arguments)})},{key:"handleError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Une erreur est survenue";return d("Erreur API",e),{success:!1,message:e.message||t,details:{error:e.message,type:e.name}}}}],n&&a(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,o,s,c,l,p,m,h}();function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=document.createElement("div");r.className="notification ".concat(t);var a=document.createElement("div");if(a.className="notification-message",a.textContent=e,r.appendChild(a),"success"===t&&n&&n.leadId){var o=JSON.parse(localStorage.getItem("odooSettings")),i=document.createElement("a");i.href="".concat(o.odooUrl,"/web#id=").concat(n.leadId,"&model=crm.lead&view_type=form"),i.target="_blank",i.className="opportunity-link",i.textContent="Voir l'opportunité dans Odoo",r.appendChild(i)}if(n){var s=document.createElement("div");if(s.className="notification-details",n.message){var c=document.createElement("div");c.className="error-message",c.textContent="Message: ".concat(n.message),s.appendChild(c)}if(n.logs&&n.logs.length>0){var u=document.createElement("div");u.className="error-logs",n.logs.forEach((function(e){var t=document.createElement("div");t.className="log-entry",t.textContent="".concat(e.timestamp||""," ").concat(e.message||e),u.appendChild(t)})),s.appendChild(u)}if(n.stack){var l=document.createElement("pre");l.className="error-stack",l.textContent=n.stack,s.appendChild(l)}r.appendChild(s)}var d=document.createElement("style");d.textContent="\n        .notification {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            max-width: 80vw;\n            max-height: 80vh;\n            overflow-y: auto;\n            padding: 15px;\n            background: white;\n            border-radius: 5px;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n            z-index: 1000;\n            font-family: monospace;\n        }\n        .notification.error { border-left: 4px solid #f44336; }\n        .notification.success { border-left: 4px solid #4CAF50; }\n        .notification-message {\n            font-weight: bold;\n            margin-bottom: 10px;\n        }\n        .opportunity-link {\n            display: block;\n            margin: 10px 0;\n            padding: 8px 12px;\n            background-color: #4CAF50;\n            color: white;\n            text-decoration: none;\n            border-radius: 4px;\n            text-align: center;\n            font-weight: bold;\n            transition: background-color 0.3s;\n        }\n        .opportunity-link:hover {\n            background-color: #45a049;\n        }\n        .notification-details {\n            font-size: 12px;\n            margin-top: 10px;\n            padding-top: 10px;\n            border-top: 1px solid #eee;\n        }\n        .error-message {\n            color: #f44336;\n            margin-bottom: 5px;\n        }\n        .error-logs {\n            margin-top: 5px;\n            padding: 5px;\n            background: #f5f5f5;\n            border-radius: 3px;\n        }\n        .log-entry {\n            padding: 2px 5px;\n            border-bottom: 1px solid #eee;\n        }\n        .error-stack {\n            margin-top: 5px;\n            padding: 5px;\n            background: #f5f5f5;\n            overflow-x: auto;\n            font-size: 11px;\n        }\n    ",document.head.appendChild(d),document.body.appendChild(r),setTimeout((function(){r.remove()}),3e4)}function v(e){document.querySelectorAll(".page").forEach((function(e){e.classList.remove("active")})),document.getElementById(e).classList.add("active"),document.querySelectorAll(".nav-button").forEach((function(e){e.classList.remove("nav-active")})),document.getElementById("app-body"===e?"nav-form":"nav-settings").classList.add("nav-active")}document.getElementById("test-connection").onclick=r(t().mark((function e(){var n,r,a,o,i,s,c,u;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=this).querySelector("i"),r=document.getElementById("odoo-url").value.trim(),a=document.getElementById("database").value.trim(),o=document.getElementById("username").value.trim(),i=document.getElementById("password").value.trim(),d("Test de connexion initié",{url:r,database:a,username:o,hasPassword:!!i}),r&&a&&o&&i){e.next=10;break}return f("Veuillez remplir tous les champs","error"),e.abrupt("return");case 10:return n.disabled=!0,n.textContent,n.innerHTML='<i class="ms-Icon ms-Icon--Sync"></i>Test en cours...',e.prev=13,s={odooUrl:r,database:a,username:o,password:i},localStorage.setItem("odooSettings",JSON.stringify(s)),c=new h,e.next=19,c.testServerConnection();case 19:if(!(u=e.sent).success){e.next=24;break}f(u.message,"success",u.details),e.next=25;break;case 24:throw new Error(u.message);case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(13),d("Erreur critique",e.t0),f(e.t0.message,"error",{"Type d'erreur":e.t0.name,"Détails":e.t0.stack||e.t0.message});case 31:return e.prev=31,n.disabled=!1,n.innerHTML='<i class="ms-Icon ms-Icon--PlugConnected"></i>Tester la connexion',e.finish(31);case 35:case"end":return e.stop()}}),e,this,[[13,27,31,35]])}))),document.getElementById("nav-form").addEventListener("click",(function(){v("app-body")})),document.getElementById("nav-settings").addEventListener("click",(function(){v("settings-page")})),document.getElementById("save-to-crm").onclick=r(t().mark((function e(){var n,r,a,o,i,s,c,u,l,p,m;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(n=this).innerHTML,e.prev=2,n.disabled=!0,n.innerHTML='<i class="ms-Icon ms-Icon--Sync"></i>Création en cours...',a=document.getElementById("sender-email").value.trim(),document.getElementById("sender-name").value.trim(),o=document.getElementById("email-subject").value.trim(),i=document.getElementById("email-body").value,s=document.getElementById("additional-notes").value.trim(),a&&o){e.next=12;break}throw new Error("L'email de l'expéditeur et le sujet sont requis");case 12:return c=new h,u='<div style="font-family: Arial, sans-serif;">',u+=i.split("\n").map((function(e){return'<p style="margin: 0 0 1em 0;">'.concat(e.trim(),"</p>")})).join(""),u+="</div>",s&&(u+='<div style="margin: 30px 0;">',u+='<hr style="border: none; border-top: 1px solid #cccccc;">',u+="<h3>Notes additionnelles :</h3>",u+='<hr style="border: none; border-top: 1px solid #cccccc;">',u+=s.split("\n").map((function(e){return'<p style="margin: 0 0 1em 0;">'.concat(e.trim(),"</p>")})).join(""),u+="</div>"),e.next=19,c.createLead(a,o,u);case 19:if(!(l=e.sent).success){e.next=26;break}p=JSON.parse(localStorage.getItem("odooSettings")),m=p.odooUrl,f("Lead créé avec succès dans Odoo","success",{leadId:l.leadId,message:l.message,logs:l.details,odooUrl:m}),e.next=27;break;case 26:throw new Error("Échec de la création du lead");case 27:e.next=34;break;case 29:e.prev=29,e.t0=e.catch(2),d("Erreur complète:",e.t0),f("Erreur lors de la création du lead","error",{message:e.t0.message,type:e.t0.name,details:e.t0.details||{},logs:e.t0.logs||[],stack:e.t0.stack});case 34:return e.prev=34,n.disabled=!1,n.innerHTML=r,e.finish(34);case 38:case"end":return e.stop()}}),e,this,[[2,29,34,38]])}))),document.getElementById("save-settings").onclick=function(){var e={odooUrl:document.getElementById("odoo-url").value.trim(),database:document.getElementById("database").value.trim(),username:document.getElementById("username").value.trim(),password:document.getElementById("password").value.trim()};if(d("Sauvegarde des réglages",{hasUrl:!!e.odooUrl,hasDatabase:!!e.database,hasUsername:!!e.username,hasPassword:!!e.password}),e.odooUrl&&e.database&&e.username&&e.password)try{localStorage.setItem("odooSettings",JSON.stringify(e)),f("Réglages sauvegardés avec succès !","success")}catch(e){d("Erreur sauvegarde réglages",e),f("Erreur lors de la sauvegarde des réglages","error")}else f("Veuillez remplir tous les champs","error")}}(),function(){"use strict";new URL(n(58394),n.b)}()}();
//# sourceMappingURL=taskpane.js.map