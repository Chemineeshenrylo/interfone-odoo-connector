/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={58394:function(e,t,r){"use strict";e.exports=r.p+"0fac4d34b908eae6e008.css"}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.m=e,r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var a=n.length-1;a>-1&&(!e||!/^http(s?):/.test(e));)e=n[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e}(),r.b=document.baseURI||self.location.href,function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function r(e){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?t(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function n(e,t,r){return(t=o(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,o(n.key),n)}}function o(t){var r=function(t){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(r)?r:r+""}function s(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=c(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,i=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){i=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(i)throw o}}}}function c(e,t){if(e){if("string"==typeof e)return i(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(e,t):void 0}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function u(){"use strict";u=function(){return r};var t,r={},n=Object.prototype,a=n.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},s="function"==typeof Symbol?Symbol:{},c=s.iterator||"@@iterator",i=s.asyncIterator||"@@asyncIterator",l=s.toStringTag||"@@toStringTag";function d(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(t){d=function(e,t,r){return e[t]=r}}function p(e,t,r,n){var a=t&&t.prototype instanceof b?t:b,s=Object.create(a.prototype),c=new B(n||[]);return o(s,"_invoke",{value:O(e,r,c)}),s}function m(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}r.wrap=p;var h="suspendedStart",f="suspendedYield",v="executing",g="completed",y={};function b(){}function w(){}function x(){}var E={};d(E,c,(function(){return this}));var k=Object.getPrototypeOf,I=k&&k(k(P([])));I&&I!==n&&a.call(I,c)&&(E=I);var T=x.prototype=b.prototype=Object.create(E);function S(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function _(t,r){function n(o,s,c,i){var u=m(t[o],t,s);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==e(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(e){n("next",e,c,i)}),(function(e){n("throw",e,c,i)})):r.resolve(d).then((function(e){l.value=e,c(l)}),(function(e){return n("throw",e,c,i)}))}i(u.arg)}var s;o(this,"_invoke",{value:function(e,t){function a(){return new r((function(r,a){n(e,t,r,a)}))}return s=s?s.then(a,a):a()}})}function O(e,r,n){var a=h;return function(o,s){if(a===v)throw Error("Generator is already running");if(a===g){if("throw"===o)throw s;return{value:t,done:!0}}for(n.method=o,n.arg=s;;){var c=n.delegate;if(c){var i=L(c,n);if(i){if(i===y)continue;return i}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(a===h)throw a=g,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a=v;var u=m(e,r,n);if("normal"===u.type){if(a=n.done?g:f,u.arg===y)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(a=g,n.method="throw",n.arg=u.arg)}}}function L(e,r){var n=r.method,a=e.iterator[n];if(a===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,L(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var o=m(a,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,y;var s=o.arg;return s?s.done?(r[e.resultName]=s.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function j(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function C(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function B(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(j,this),this.reset(!0)}function P(r){if(r||""===r){var n=r[c];if(n)return n.call(r);if("function"==typeof r.next)return r;if(!isNaN(r.length)){var o=-1,s=function e(){for(;++o<r.length;)if(a.call(r,o))return e.value=r[o],e.done=!1,e;return e.value=t,e.done=!0,e};return s.next=s}}throw new TypeError(e(r)+" is not iterable")}return w.prototype=x,o(T,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:w,configurable:!0}),w.displayName=d(x,l,"GeneratorFunction"),r.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},r.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,d(e,l,"GeneratorFunction")),e.prototype=Object.create(T),e},r.awrap=function(e){return{__await:e}},S(_.prototype),d(_.prototype,i,(function(){return this})),r.AsyncIterator=_,r.async=function(e,t,n,a,o){void 0===o&&(o=Promise);var s=new _(p(e,t,n,a),o);return r.isGeneratorFunction(t)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(T),d(T,l,"Generator"),d(T,c,(function(){return this})),d(T,"toString",(function(){return"[object Generator]"})),r.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},r.values=P,B.prototype={constructor:B,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(n,a){return c.type="throw",c.arg=e,r.next=n,a&&(r.method="next",r.arg=t),!!a}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],c=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var i=a.call(s,"catchLoc"),u=a.call(s,"finallyLoc");if(i&&u){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(i){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&a.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,y):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),C(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;C(r)}return a}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}},r}function l(e,t,r,n,a,o,s){try{var c=e[o](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,a)}function d(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function s(e){l(o,n,a,s,c,"next",e)}function c(e){l(o,n,a,s,c,"throw",e)}s(void 0)}))}}function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=(new Date).toISOString(),n="[".concat(r,"] ").concat(e);t?(console.group(n),console.log("Détails:",t),t instanceof Error&&console.log("Stack:",t.stack),console.groupEnd()):console.log(n)}Office.onReady((function(e){p("Office.onReady appelé",e),e.host===Office.HostType.Outlook&&(p("Application démarrée dans Outlook"),document.getElementById("sideload-msg").style.display="none",document.getElementById("app-body").style.display="block",d(u().mark((function e(){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,T();case 3:j(),C(),B(),U(),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),p("Erreur lors du chargement initial:",e.t0);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})))())}));var m=document.createElement("style");function h(e){function t(e){return(e.match(/\d/g)||[]).length}function r(e){if(t(e)<6)return null;var r=e.trim().replace(/[\(\)]/g,"").replace(/[-\.]/g," ").replace(/\s+/g," ");return r.startsWith("00")&&(r="+"+r.slice(2)),{formatted:r,digitCount:t(r)}}for(var n=new Map,a=0,o=[/(?:\+|00)[1-9]\d{1,3}[- .]?\d(?:[- .]?\d){4,14}/g,/\d(?:[- .]?\d){5,14}/g];a<o.length;a++){var c,i=o[a],u=s(e.matchAll(i));try{for(u.s();!(c=u.n()).done;){var l=r(c.value[0]);l&&l.digitCount>=6&&(n.has(l.formatted)||n.set(l.formatted,l))}}catch(e){u.e(e)}finally{u.f()}}return Array.from(n.values())}function f(e){for(var t=document.getElementById("phone-select"),r=document.getElementById("phone-number");t.options.length>1;)t.remove(1);e.forEach((function(e,r){var n=document.createElement("option");n.value=e.formatted,n.textContent="Numéro ".concat(r+1,": ").concat(e.formatted),t.appendChild(n)})),e.length>0&&(r.value=e[0].formatted)}function v(){return g.apply(this,arguments)}function g(){return(g=d(u().mark((function e(){var t,r,n,a,o,s,l,d,m,h,f;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=Office.context.mailbox.item,r=t.subject||"Sans sujet",n=t.sender.emailAddress,a=t.dateTimeCreated.toISOString(),e.next=7,new Promise((function(e,r){t.body.getAsync(Office.CoercionType.Text,(function(t){t.status===Office.AsyncResultStatus.Succeeded?e(t.value):r(new Error("Échec du chargement du corps du message"))}))}));case 7:return o=e.sent,s=["From: "+n,"Subject: "+r,"Date: "+a,"Content-Type: text/plain; charset=utf-8","",o].join("\r\n"),l=new TextEncoder,d=l.encode(s),m=btoa(String.fromCharCode.apply(String,function(e){if(Array.isArray(e))return i(e)}(u=d)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(u)||c(u)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())),h=r.replace(/[^a-z0-9]/gi,"_").slice(0,30),f="".concat(h,"_").concat((new Date).toISOString().slice(0,10),".eml"),e.abrupt("return",{name:f,datas:m,mimetype:"message/rfc822",type:"binary"});case 17:throw e.prev=17,e.t0=e.catch(0),p("Erreur lors de la création de l'EML:",e.t0),e.t0;case 21:case"end":return e.stop()}var u}),e,null,[[0,17]])})))).apply(this,arguments)}function y(e){e&&function(e){return E.apply(this,arguments)}(e).catch((function(e){console.error("Erreur lors du chargement des pièces jointes:",e),A("Erreur lors du chargement des pièces jointes","error")}))}function b(){var e=document.getElementById("phone-number");document.getElementById("phone-select").addEventListener("change",(function(t){t.target.value&&(e.value=t.target.value)})),e.addEventListener("input",(function(e){var t=e.target.value;t=t.replace(/[^\d+\s]/g,""),e.target.value=t}))}function w(e){var t,r=new Map,n=s(e.matchAll(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g));try{for(n.s();!(t=n.n()).done;){var a=t.value[0].toLowerCase().trim();if(!r.has(a)){var o=!a.split("@")[1].includes("cheminees");r.set(a,{email:a,isPriority:o})}}}catch(e){n.e(e)}finally{n.f()}return Array.from(r.values()).sort((function(e,t){return e.isPriority!==t.isPriority?e.isPriority?-1:1:e.email.localeCompare(t.email)}))}function x(e){for(var t=document.getElementById("email-select"),r=document.getElementById("sender-email");t.options.length>1;)t.remove(1);e.forEach((function(e,r){var n=document.createElement("option");n.value=e.email;var a=e.isPriority?"🔵":"⚪";n.textContent="".concat(a," Email ").concat(r+1,": ").concat(e.email),t.appendChild(n)})),e.length>0&&(r.value=e[0].email)}function E(){return(E=d(u().mark((function e(t){var r,n,a,o,c,i,l,d,p,m,h,f,v,g,y,b,w;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.innerHTML="",console.log("Début du chargement des pièces jointes"),r=Office.context.mailbox.item,window.attachmentsToUpload=[],n=0,!r.attachments){e.next=35;break}a=r.attachments.filter((function(e){return!e.isInline||e.contentType&&e.contentType.startsWith("image/")})),o=s(a),e.prev=8,o.s();case 10:if((c=o.n()).done){e.next=27;break}return i=c.value,e.prev=12,e.next=15,O(i.id);case 15:l=e.sent,d=void 0,i.isInline&&i.contentType.startsWith("image/")?(d=k("data:".concat(i.contentType,";base64,").concat(l),n,i.name),window.attachmentsToUpload[n]={name:i.name,datas:l,mimetype:i.contentType,type:"binary",isInline:!0}):(p={name:i.name,datas:l,mimetype:i.contentType||"application/octet-stream",type:"binary"},d=I(p,n),window.attachmentsToUpload[n]=p),t.appendChild(d),n++,e.next=25;break;case 22:e.prev=22,e.t0=e.catch(12),console.error("Erreur chargement pièce jointe ".concat(i.name,":"),e.t0);case 25:e.next=10;break;case 27:e.next=32;break;case 29:e.prev=29,e.t1=e.catch(8),o.e(e.t1);case 32:return e.prev=32,o.f(),e.finish(32);case 35:return e.prev=35,e.next=38,new Promise((function(e,t){r.body.getAsync(Office.CoercionType.Html,{asyncContext:"This is passed to the callback"},(function(r){r.status===Office.AsyncResultStatus.Succeeded?e(r.value):t(new Error("Échec chargement HTML"))}))}));case 38:m=e.sent,(h=document.createElement("div")).innerHTML=m,f=Array.from(h.getElementsByTagName("img")).filter((function(e){var t=e.src||e.getAttribute("src");return t&&!t.startsWith("cid:")&&!t.startsWith("data:")&&!t.includes("outlook.office365.com")&&!t.includes("outlook.office.com")})),v=s(f);try{for(v.s();!(g=v.n()).done;)y=g.value,(b=y.src||y.getAttribute("src"))&&(w=k(b,n,"Image ".concat(n+1)),t.appendChild(w),window.attachmentsToUpload[n]={name:"Image ".concat(n+1,".png"),src:b,type:"image",mimetype:"image/png"},n++)}catch(e){v.e(e)}finally{v.f()}e.next=49;break;case 46:e.prev=46,e.t2=e.catch(35),console.error("Erreur chargement images:",e.t2);case 49:case"end":return e.stop()}}),e,null,[[8,29,32,35],[12,22],[35,46]])})))).apply(this,arguments)}function k(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=document.createElement("div");n.className="attachment-item";var a=r||"Image ".concat(t+1);return n.innerHTML='\n        <input type="checkbox" id="image-'.concat(t,'" data-type="image" data-src="').concat(e,'" checked>\n        <img src="').concat(e,'" class="image-preview" alt="Preview" onerror="this.style.display=\'none\'">\n        <label for="image-').concat(t,'">\n            ').concat(a,'\n            <br>\n            <small class="image-source">').concat(e.startsWith("data:")?"Image intégrée":e.substring(0,50)+"...","</small>\n        </label>\n    "),n}function I(e,t){var r=document.createElement("div");return r.className="attachment-item",r.innerHTML='\n        <input type="checkbox" id="attachment-'.concat(t,'" data-type="file" checked>\n        <label for="attachment-').concat(t,'">\n            ').concat(e.name,'\n            <span class="file-type">(').concat(e.mimetype,")</span>\n        </label>\n    "),r}function T(){return S.apply(this,arguments)}function S(){return(S=d(u().mark((function e(){var t,r,n,a,o,c,i,l,d,m,g,E,k,I;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(p("Chargement des données de l'email"),!(t=Office.context.mailbox.item)){e.next=76;break}return b(),window.attachmentsToUpload=[],e.prev=5,e.next=8,v();case 8:r=e.sent,window.attachmentsToUpload.push(r),p("EML du mail créé et ajouté aux pièces jointes"),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(5),p("Erreur lors de la création de l'EML:",e.t0);case 16:if(!(t.attachments&&t.attachments.length>0)){e.next=54;break}p("Nombre de pièces jointes trouvées:",t.attachments.length),n=s(t.attachments),e.prev=19,n.s();case 21:if((a=n.n()).done){e.next=41;break}if(!(o=a.value).isInline){e.next=25;break}return e.abrupt("continue",39);case 25:return e.prev=25,_(o.name,"progress","Récupération en cours..."),e.next=29,O(o.id);case 29:c=e.sent,window.attachmentsToUpload.push({name:o.name,datas:c,mimetype:o.contentType||"application/octet-stream",res_model:"crm.lead",type:"binary"}),_(o.name,"success"),p("Pièce jointe préparée:",{name:o.name,type:o.contentType,size:o.size}),e.next=39;break;case 35:e.prev=35,e.t1=e.catch(25),p("Erreur lors du traitement de la pièce jointe:",e.t1),_(o.name,"error",e.t1.message);case 39:e.next=21;break;case 41:e.next=46;break;case 43:e.prev=43,e.t2=e.catch(19),n.e(e.t2);case 46:return e.prev=46,n.f(),e.finish(46);case 49:(i=document.getElementById("attachments-list"))&&y(i),p("Pièces jointes préparées:",window.attachmentsToUpload.length),e.next=56;break;case 54:p("Aucune pièce jointe trouvée"),y([]);case 56:return e.prev=56,e.next=59,new Promise((function(e,r){t.body.getAsync(Office.CoercionType.Text,(function(t){t.status===Office.AsyncResultStatus.Succeeded?e(t):r(new Error("Échec du chargement du corps du message"))}))}));case 59:l=e.sent,d=l.value,document.getElementById("email-body").value=d,p("Numéros de téléphone détectés:",m=h(d)),f(m),p("Emails détectés:",g=w(d)),x(g),e.next=73;break;case 70:e.prev=70,e.t3=e.catch(56),p("Erreur lors du chargement du corps du message:",e.t3);case 73:t.sender&&(E=t.sender.emailAddress,k=t.sender.displayName,E=L(E),k=k||E.split("@")[0],document.getElementById("sender-name").value=k,document.getElementById("sender-email").value=E),I=t.subject||"",document.getElementById("email-subject").value=I;case 76:case"end":return e.stop()}}),e,null,[[5,13],[19,43,46,49],[25,35],[56,70]])})))).apply(this,arguments)}function _(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=document.getElementById("progress-container")||function(){var e=document.createElement("div");e.id="progress-container",e.style.cssText="\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        width: 300px;\n        max-height: 80vh;\n        overflow-y: auto;\n        z-index: 1000;\n    ";var t=document.createElement("style");return t.textContent="\n        .file-progress {\n            margin: 10px;\n            padding: 10px;\n            border-radius: 4px;\n            background: #f8f9fa;\n            border: 1px solid #ddd;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n        }\n        .file-progress.progress {\n            background: #e8f4f8;\n            border-color: #b8daff;\n        }\n        .file-progress.success {\n            background: #d4edda;\n            border-color: #c3e6cb;\n        }\n        .file-progress.error {\n            background: #f8d7da;\n            border-color: #f5c6cb;\n        }\n        .filename {\n            display: block;\n            font-weight: bold;\n            margin-bottom: 5px;\n            word-break: break-all;\n        }\n        .status {\n            display: block;\n            font-size: 0.9em;\n            color: #666;\n        }\n        .spinner {\n            margin-top: 5px;\n            width: 20px;\n            height: 20px;\n            border: 2px solid #ccc;\n            border-top-color: #007bff;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n        @keyframes spin {\n            to { transform: rotate(360deg); }\n        }\n    ",document.head.appendChild(t),document.body.appendChild(e),e}(),a=n.querySelector('[data-file="'.concat(e,'"]'))||function(e){var t=document.createElement("div");return t.className="file-progress",t.dataset.file=e,document.getElementById("progress-container").appendChild(t),t}(e);switch(t){case"progress":a.className="file-progress progress",a.innerHTML='\n                <span class="filename">'.concat(e,'</span>\n                <span class="status">').concat(r,'</span>\n                <div class="spinner"></div>\n            ');break;case"success":a.className="file-progress success",a.innerHTML='\n                <span class="filename">'.concat(e,'</span>\n                <span class="status">Traitement terminé ✓</span>\n            '),setTimeout((function(){return a.remove()}),3e3);break;case"error":a.className="file-progress error",a.innerHTML='\n                <span class="filename">'.concat(e,'</span>\n                <span class="status">Erreur: ').concat(r,"</span>\n            ")}}function O(e){return new Promise((function(t,r){Office.context.mailbox.item.getAttachmentContentAsync(e,(function(e){e.status===Office.AsyncResultStatus.Succeeded?t(e.value.content):r(new Error("Échec de récupération de la pièce jointe: ".concat(e.error.message)))}))}))}function L(e){return e?((e=(e=e.replace(/<mailto:/g,"").replace(/>/g,"")).trim()).includes(" ")&&(e=e.split(" ")[0]),e):""}function j(){p("Chargement des données de l'utilisateur");var e=Office.context.mailbox.userProfile;if(e){var t=e.emailAddress;document.getElementById("user-email").value=t,p("Email de l'utilisateur chargé:",t)}else p("Profil utilisateur non disponible")}function C(){p("Chargement des réglages sauvegardés");try{var e=localStorage.getItem("odooSettings");if(e){var t=JSON.parse(e);p("Réglages trouvés",{hasUrl:!!t.odooUrl,hasDatabase:!!t.database,hasUsername:!!t.username,hasPassword:!!t.password}),document.getElementById("odoo-url").value=t.odooUrl||"",document.getElementById("database").value=t.database||"",document.getElementById("username").value=t.username||"",document.getElementById("password").value=t.password||""}else p("Aucun réglage sauvegardé trouvé")}catch(e){p("Erreur lors du chargement des réglages",e)}}function B(){var e=document.getElementById("password"),t=document.getElementById("toggle-password");e&&t&&t.addEventListener("click",(function(){var r="password"===e.type?"text":"password";e.type=r;var n=t.querySelector("i");"password"===r?n.classList.replace("ms-Icon--Hide","ms-Icon--RedEye"):n.classList.replace("ms-Icon--RedEye","ms-Icon--Hide")}))}m.textContent="\n    .phone-input-container {\n        position: relative;\n        display: flex;\n        gap: 8px;\n    }\n    \n    #phone-number {\n        flex: 1;\n        padding: 8px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n    }\n    \n    #phone-select {\n        width: auto;\n        min-width: 120px;\n        padding: 8px;\n        border: 1px solid #ddd;\n        border-radius: 4px;\n        background-color: #f8f9fa;\n    }\n",document.head.appendChild(m);var P=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var t=this.getSettings();this.host=t.odooUrl,this.db=t.database,this.username=t.username,this.password=t.password,this.worker_url="https://royal-pond-be25.lvr-3b7.workers.dev",this.maxRetries=3,this.retryDelay=1e3,p("OdooAPI initialisée",{host:this.host,database:this.db,username:this.username,worker_url:this.worker_url})},t=[{key:"getSettings",value:function(){var e=localStorage.getItem("odooSettings");if(!e)throw new Error("Aucun réglage trouvé. Veuillez configurer l'add-in dans les paramètres.");var t=JSON.parse(e);if(!(t.odooUrl&&t.database&&t.username&&t.password))throw new Error("Configuration incomplète. Veuillez vérifier vos paramètres.");return t}},{key:"formatOdooUrl",value:function(e){return e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e),e.replace(/\/$/,"")}},{key:"retryRequest",value:(v=d(u().mark((function e(t){var r,n,a,o=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=u().mark((function e(r){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t();case 3:return e.t0=e.sent,e.abrupt("return",{v:e.t0});case 7:if(e.prev=7,e.t1=e.catch(0),p("Tentative ".concat(r+1,"/").concat(o.maxRetries," échouée"),e.t1),r!==o.maxRetries-1){e.next=12;break}throw e.t1;case 12:return e.next=14,new Promise((function(e){return setTimeout(e,o.retryDelay*(r+1))}));case 14:case"end":return e.stop()}}),e,null,[[0,7]])})),a=0;case 2:if(!(a<this.maxRetries)){e.next=10;break}return e.delegateYield(r(a),"t0",4);case 4:if(!(n=e.t0)){e.next=7;break}return e.abrupt("return",n.v);case 7:a++,e.next=2;break;case 10:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"escapeXml",value:function(e){return"string"!=typeof e?e:e.replace(/[<>&'"]/g,(function(e){switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;";default:return e}})).replace(/[\x00-\x1F\x7F-\x9F]/g,"").trim()}},{key:"createLead",value:(f=d(u().mark((function e(t,r,n){var a,o,c,i,l,d,m,h,f,v,g,y,b,w,x,E;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getUserId();case 3:return a=e.sent,o=document.getElementById("sender-name").value.trim(),c=document.getElementById("phone-number").value.trim(),p("Données nettoyées pour création lead:",i={name:this.escapeXml(r||"Nouveau lead"),email_from:this.escapeXml(t),description:this.escapeXml(n),user_id:a,type:"opportunity",active:!0,company_id:1,stage_id:16,contact_name:this.escapeXml(o||t.split("@")[0]),phone:this.escapeXml(c)}),e.next=10,this.fetchWithTimeout("".concat(this.worker_url,"/create_lead"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,lead_data:i})});case 10:return l=e.sent,e.next=13,l.text();case 13:p("Réponse brute création lead:",d=e.sent),e.prev=15,m=JSON.parse(d),e.next=22;break;case 19:throw e.prev=19,e.t0=e.catch(15),new Error("Réponse invalide du serveur: ".concat(d));case 22:if(m.success){e.next=24;break}throw new Error(m.error||"Réponse serveur indique un échec");case 24:if(h=m.lead_id,!(window.attachmentsToUpload&&window.attachmentsToUpload.length>0)){e.next=67;break}p("Début upload des pièces jointes (".concat(window.attachmentsToUpload.length,")")),f=document.querySelectorAll('.attachment-item input[type="checkbox"]:checked'),v=s(f),e.prev=29,v.s();case 31:if((g=v.n()).done){e.next=59;break}if(y=g.value,b=parseInt(y.id.split("-")[1]),w=window.attachmentsToUpload[b]){e.next=38;break}return console.error("Pièce jointe non trouvée pour l'index ".concat(b)),e.abrupt("continue",57);case 38:return e.prev=38,p("Début upload pièce jointe:",{name:w.name,size:w.datas.length}),e.next=42,this.fetchWithTimeout("".concat(this.worker_url,"/create_attachment"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,attachment_data:{name:w.name,datas:w.datas,res_model:"crm.lead",res_id:h,mimetype:w.mimetype,type:"binary"}})},6e4);case 42:return x=e.sent,e.next=45,x.json();case 45:if((E=e.sent).success){e.next=48;break}throw new Error(E.error||"Échec de création de la pièce jointe");case 48:p("Pièce jointe uploadée avec succès:",{name:w.name,id:E.attachment_id}),_(w.name,"success","Upload terminé"),e.next=57;break;case 52:throw e.prev=52,e.t1=e.catch(38),p("Erreur upload pièce jointe:",{name:w.name,error:e.t1.message}),_(w.name,"error",e.t1.message),e.t1;case 57:e.next=31;break;case 59:e.next=64;break;case 61:e.prev=61,e.t2=e.catch(29),v.e(e.t2);case 64:return e.prev=64,v.f(),e.finish(64);case 67:return e.abrupt("return",{success:!0,leadId:h,message:"Lead et références des pièces jointes créés avec succès",details:m});case 70:throw e.prev=70,e.t3=e.catch(0),p("Erreur détaillée création lead:",e.t3),e.t3;case 74:case"end":return e.stop()}}),e,this,[[0,70],[15,19],[29,61,64,67],[38,52]])}))),function(e,t,r){return f.apply(this,arguments)})},{key:"createAttachment",value:(h=d(u().mark((function e(t){var n,a,o;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,p("Création pièce jointe:",{model:(n=r(r({},t),{},{res_model:t.res_model||"crm.lead"})).res_model,resId:n.res_id,fileName:n.name}),e.next=5,this.fetchWithTimeout("".concat(this.worker_url,"/create_attachment"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,attachment_data:n})},6e4);case 5:return a=e.sent,e.next=8,a.json();case 8:if((o=e.sent).success){e.next=11;break}throw new Error(o.error||"Échec de création de la pièce jointe");case 11:return p("Pièce jointe créée avec succès:",{attachmentId:o.attachment_id,model:n.res_model,resId:n.res_id}),e.abrupt("return",{success:!0,attachment_id:o.attachment_id});case 15:throw e.prev=15,e.t0=e.catch(0),p("Erreur création pièce jointe:",e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[0,15]])}))),function(e){return h.apply(this,arguments)})},{key:"getUserId",value:(m=d(u().mark((function e(){var t,r;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.fetchWithTimeout("".concat(this.worker_url,"/get_user_id"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password})});case 3:if((t=e.sent).ok){e.next=6;break}throw new Error("Erreur HTTP ".concat(t.status));case 6:return e.next=8,t.json();case 8:if((r=e.sent).success&&r.user_id){e.next=11;break}throw new Error("Impossible de récupérer l'ID utilisateur");case 11:return e.abrupt("return",r.user_id);case 14:throw e.prev=14,e.t0=e.catch(0),new Error("Erreur lors de la récupération de l'ID utilisateur: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,this,[[0,14]])}))),function(){return m.apply(this,arguments)})},{key:"uploadLargeAttachment",value:(l=d(u().mark((function e(t,r){var n,a,o,s,c,i,l,d,m,h;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=512e3,a=Math.ceil(r.datas.length/n),o=null,p("Début upload par chunks pour ".concat(r.name),{totalSize:r.datas.length,chunks:a}),s=0;case 5:if(!(s<a)){e.next=29;break}return c=s*n,i=Math.min(c+n,r.datas.length),l=r.datas.slice(c,i),d=s===a-1,e.prev=10,e.next=13,this.fetchWithTimeout("".concat(this.worker_url,"/upload_attachment_chunk"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,attachment_data:{name:r.name,datas:l,res_model:"crm.lead",res_id:t,mimetype:r.mimetype,chunk_index:s,total_chunks:a,is_last_chunk:d,attachment_id:o}})},15e3);case 13:return m=e.sent,e.next=16,m.json();case 16:if((h=e.sent).success){e.next=19;break}throw new Error(h.error||"Échec upload chunk");case 19:0===s&&(o=h.attachment_id),_(r.name,"progress","Upload en cours... ".concat(Math.round((s+1)/a*100),"%")),e.next=26;break;case 23:throw e.prev=23,e.t0=e.catch(10),new Error("Erreur chunk ".concat(s+1,"/").concat(a,": ").concat(e.t0.message));case 26:s++,e.next=5;break;case 29:return e.abrupt("return",o);case 30:case"end":return e.stop()}}),e,this,[[10,23]])}))),function(e,t){return l.apply(this,arguments)})},{key:"testServerConnection",value:(i=d(u().mark((function e(){var t=this;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p("Test de connexion au serveur",{url:this.worker_url,odoo_url:this.host}),e.abrupt("return",this.retryRequest(d(u().mark((function e(){var r,n,a,o,s,c;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.fetchWithTimeout("".concat(t.worker_url,"/test"),{method:"POST",headers:t.buildHeaders(),body:JSON.stringify({odoo_url:t.host,database:t.db,username:t.username,password:t.password})});case 3:if((a=e.sent).ok){e.next=9;break}return e.next=7,a.json().catch((function(){return{}}));case 7:throw o=e.sent,new Error(o.error||"Erreur HTTP ".concat(a.status));case 9:return e.next=11,a.json();case 11:if(p("Réponse du test de connexion",s=e.sent),(null===(r=s.details)||void 0===r||null===(r=r.login_response)||void 0===r?void 0:r.includes("<value><int>"))||(null===(n=s.details)||void 0===n||null===(n=n.login_response)||void 0===n?void 0:n.includes("<value><boolean>1</boolean>"))){e.next=16;break}throw new Error("Échec de l'authentification. Vérifiez vos identifiants de connexion.");case 16:return c=t.extractVersionInfo(s.details.version_response),e.abrupt("return",{success:!0,message:"Connexion établie avec succès (Odoo ".concat(c.version,")"),details:{version:c,responses:s.details}});case 20:return e.prev=20,e.t0=e.catch(0),e.abrupt("return",t.handleError(e.t0,"Erreur lors du test de connexion"));case 23:case"end":return e.stop()}}),e,null,[[0,20]])})))));case 2:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"searchPartners",value:(c=d(u().mark((function e(t){var r,n;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.fetchWithTimeout("".concat(this.worker_url,"/search_partners"),{method:"POST",headers:this.buildHeaders(),body:JSON.stringify({odoo_url:this.host,database:this.db,username:this.username,password:this.password,search_criteria:t})});case 3:return r=e.sent,e.next=6,r.json();case 6:if((n=e.sent).success){e.next=9;break}throw new Error(n.error||"Échec de la recherche");case 9:return e.abrupt("return",n.partners);case 12:throw e.prev=12,e.t0=e.catch(0),p("Erreur recherche partenaires:",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(e){return c.apply(this,arguments)})},{key:"extractVersionInfo",value:function(e){try{var t=e.match(/<name>server_version<\/name>\s*<value><string>(.*?)<\/string><\/value>/),r=t?t[1]:"Version inconnue",n=e.match(/<name>server_serie<\/name>\s*<value><string>(.*?)<\/string><\/value>/);return{version:r,serie:n?n[1]:""}}catch(e){return p("Erreur extraction version",e),{version:"Version inconnue",serie:"Inconnue"}}}},{key:"validateCredentials",value:function(){if(!this.host||!this.db||!this.password)throw new Error("Configuration incomplète: tous les paramètres de connexion sont requis")}},{key:"init",value:(o=d(u().mark((function e(){var t;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.validateCredentials(),this.host=this.formatOdooUrl(this.host),e.next=5,this.testServerConnection();case 5:if((t=e.sent).success){e.next=8;break}throw new Error("Échec de l'initialisation: ".concat(t.message));case 8:return p("Initialisation réussie",t),e.abrupt("return",t);case 12:throw e.prev=12,e.t0=e.catch(0),p("Erreur lors de l'initialisation",e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(){return o.apply(this,arguments)})},{key:"buildHeaders",value:function(){return{"Content-Type":"application/json","X-Api-Key":this.password}}},{key:"fetchWithTimeout",value:(n=d(u().mark((function e(t,n){var a,o,s,c,i=arguments;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=i.length>2&&void 0!==i[2]?i[2]:3e4,o=new AbortController,s=setTimeout((function(){return o.abort()}),a),e.prev=3,e.next=6,fetch(t,r(r({},n),{},{signal:o.signal}));case 6:return c=e.sent,clearTimeout(s),e.abrupt("return",c);case 11:if(e.prev=11,e.t0=e.catch(3),clearTimeout(s),"AbortError"!==e.t0.name){e.next=16;break}throw new Error("La requête a pris trop de temps");case 16:throw e.t0;case 17:case"end":return e.stop()}}),e,null,[[3,11]])}))),function(e,t){return n.apply(this,arguments)})},{key:"handleError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Une erreur est survenue";return p("Erreur API",e),{success:!1,message:e.message||t,details:{error:e.message,type:e.name}}}}],t&&a(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,o,c,i,l,m,h,f,v}();function A(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=document.createElement("div");n.className="notification ".concat(t);var a=document.createElement("div");if(a.className="notification-message",a.textContent=e,n.appendChild(a),"success"===t&&r&&r.leadId){var o=JSON.parse(localStorage.getItem("odooSettings")),s=document.createElement("a");s.href="".concat(o.odooUrl,"/web#id=").concat(r.leadId,"&model=crm.lead&view_type=form"),s.target="_blank",s.className="opportunity-link",s.textContent="Voir l'opportunité dans Odoo",n.appendChild(s)}if(r){var c=document.createElement("div");if(c.className="notification-details",r.message){var i=document.createElement("div");i.className="error-message",i.textContent="Message: ".concat(r.message),c.appendChild(i)}if(r.logs&&r.logs.length>0){var u=document.createElement("div");u.className="error-logs",r.logs.forEach((function(e){var t=document.createElement("div");t.className="log-entry",t.textContent="".concat(e.timestamp||""," ").concat(e.message||e),u.appendChild(t)})),c.appendChild(u)}if(r.stack){var l=document.createElement("pre");l.className="error-stack",l.textContent=r.stack,c.appendChild(l)}n.appendChild(c)}var d=document.createElement("style");d.textContent="\n        .notification {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            max-width: 80vw;\n            max-height: 80vh;\n            overflow-y: auto;\n            padding: 15px;\n            background: white;\n            border-radius: 5px;\n            box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n            z-index: 1000;\n            font-family: monospace;\n        }\n        .notification.error { border-left: 4px solid #f44336; }\n        .notification.success { border-left: 4px solid #4CAF50; }\n        .notification-message {\n            font-weight: bold;\n            margin-bottom: 10px;\n        }\n        .opportunity-link {\n            display: block;\n            margin: 10px 0;\n            padding: 8px 12px;\n            background-color: #4CAF50;\n            color: white;\n            text-decoration: none;\n            border-radius: 4px;\n            text-align: center;\n            font-weight: bold;\n            transition: background-color 0.3s;\n        }\n        .opportunity-link:hover {\n            background-color: #45a049;\n        }\n        .notification-details {\n            font-size: 12px;\n            margin-top: 10px;\n            padding-top: 10px;\n            border-top: 1px solid #eee;\n        }\n        .error-message {\n            color: #f44336;\n            margin-bottom: 5px;\n        }\n        .error-logs {\n            margin-top: 5px;\n            padding: 5px;\n            background: #f5f5f5;\n            border-radius: 3px;\n        }\n        .log-entry {\n            padding: 2px 5px;\n            border-bottom: 1px solid #eee;\n        }\n        .error-stack {\n            margin-top: 5px;\n            padding: 5px;\n            background: #f5f5f5;\n            overflow-x: auto;\n            font-size: 11px;\n        }\n    ",document.head.appendChild(d),document.body.appendChild(n),setTimeout((function(){n.remove()}),3e4)}function N(e){var t=document.getElementById("app-body"),r=document.getElementById("settings-page"),n=document.getElementById("search-page");switch(t.classList.remove("slide-left"),r.classList.remove("active"),n.classList.remove("active"),e){case"settings-page":t.classList.add("slide-left"),r.classList.add("active");break;case"search-page":t.classList.add("slide-left"),n.classList.add("active")}}function U(){var e=["sender-email","email-subject"],t=document.getElementById("save-to-crm");function r(){var r=e.every((function(e){var t=document.getElementById(e);return t&&""!==t.value.trim()}));t.disabled=!r}e.forEach((function(e){var t=document.getElementById(e);t&&(t.addEventListener("input",r),t.addEventListener("change",r))})),r()}document.getElementById("test-connection").onclick=d(u().mark((function e(){var t,r,n,a,o,s,c,i;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=this).querySelector("i"),r=document.getElementById("odoo-url").value.trim(),n=document.getElementById("database").value.trim(),a=document.getElementById("username").value.trim(),o=document.getElementById("password").value.trim(),p("Test de connexion initié",{url:r,database:n,username:a,hasPassword:!!o}),r&&n&&a&&o){e.next=10;break}return A("Veuillez remplir tous les champs","error"),e.abrupt("return");case 10:return t.disabled=!0,t.textContent,t.innerHTML='<i class="ms-Icon ms-Icon--Sync"></i>Test en cours...',e.prev=13,s={odooUrl:r,database:n,username:a,password:o},localStorage.setItem("odooSettings",JSON.stringify(s)),c=new P,e.next=19,c.testServerConnection();case 19:if(!(i=e.sent).success){e.next=24;break}A(i.message,"success",i.details),e.next=25;break;case 24:throw new Error(i.message);case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(13),p("Erreur critique",e.t0),A(e.t0.message,"error",{"Type d'erreur":e.t0.name,"Détails":e.t0.stack||e.t0.message});case 31:return e.prev=31,t.disabled=!1,t.innerHTML='<i class="ms-Icon ms-Icon--PlugConnected"></i>Tester la connexion',e.finish(31);case 35:case"end":return e.stop()}}),e,this,[[13,27,31,35]])}))),document.getElementById("settings-button").addEventListener("click",(function(){N("settings-page"),document.getElementById("back-button").classList.add("visible")})),document.getElementById("back-button").addEventListener("click",(function(){N("app-body"),document.getElementById("back-button").classList.remove("visible")})),document.getElementById("search-button").addEventListener("click",d(u().mark((function e(){var t,r,n,a,o,s;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,N("search-page"),document.getElementById("back-button").classList.add("visible"),!(t=Office.context.mailbox.item)){e.next=23;break}return t.sender&&(r=L(r=t.sender.emailAddress),document.getElementById("search-sender-email").value=r),e.prev=6,e.next=9,new Promise((function(e,r){t.body.getAsync(Office.CoercionType.Text,(function(t){t.status===Office.AsyncResultStatus.Succeeded?e(t):r(new Error("Échec du chargement du corps du message"))}))}));case 9:for(n=e.sent,a=n.value,p("Numéros de téléphone détectés pour la recherche:",o=h(a)),s=document.getElementById("search-phone-select");s.options.length>1;)s.remove(1);o.forEach((function(e,t){var r=document.createElement("option");r.value=e.formatted,r.textContent="Numéro ".concat(t+1,": ").concat(e.formatted),s.appendChild(r)})),o.length>0&&(document.getElementById("search-phone-number").value=o[0].formatted),e.next=23;break;case 19:throw e.prev=19,e.t0=e.catch(6),p("Erreur lors du chargement du corps du message:",e.t0),e.t0;case 23:e.next=29;break;case 25:e.prev=25,e.t1=e.catch(0),console.error("Erreur lors du chargement des données:",e.t1),A("Erreur lors du chargement des données","error",{message:e.t1.message});case 29:case"end":return e.stop()}}),e,null,[[0,25],[6,19]])})))),document.getElementById("search-phone-select").addEventListener("change",(function(e){e.target.value&&(document.getElementById("search-phone-number").value=e.target.value)})),document.getElementById("search-contact-btn").addEventListener("click",d(u().mark((function e(){var t,n,a,o,c,i,l,p,m,h;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("search-contact-btn"),n=document.getElementById("search-results"),e.prev=2,t.disabled=!0,t.innerHTML='<i class="ms-Icon ms-Icon--Sync"></i>Recherche en cours...',a=document.getElementById("search-email-checkbox").checked,o=document.getElementById("search-phone-checkbox").checked,c={},a&&(i=document.getElementById("search-sender-email").value.trim())&&(c.email=i),o&&(l=(l=document.getElementById("search-phone-number").value.trim()).replace(/[^0-9+]/g,""))&&(c.phone=l),0!==Object.keys(c).length){e.next=13;break}return A("Veuillez sélectionner et remplir au moins un critère de recherche","error"),e.abrupt("return");case 13:return p=new P,e.next=16,p.searchPartners(c);case 16:m=e.sent,n.innerHTML="",0===m.length?n.innerHTML='\n                <div class="no-results">\n                    Aucun contact trouvé avec ces critères\n                </div>\n            ':((h=document.createElement("div")).className="partner-cards",m.forEach((function(e){var t=document.createElement("div");t.className="partner-card",t.innerHTML='\n                    <div class="card-header">\n                        <input type="checkbox" class="partner-select" data-partner-id="'.concat(e.id,'">\n                        <h3 class="partner-name">').concat(e.name,'</h3>\n                    </div>\n                    <div class="card-content">\n                        <p class="partner-street">').concat(e.street||"",'</p>\n                        <p class="partner-city">').concat(e.zip||""," ").concat(e.city||"",'</p>\n                    </div>\n                    <div class="card-footer">\n                        <a href="').concat(p.host,"/web#id=").concat(e.id,'&model=res.partner&view_type=form" \n                           target="_blank" \n                           class="view-button">\n                           Voir dans Odoo\n                        </a>\n                        <button class="upload-button" style="display: none;" data-partner-id="').concat(e.id,'">\n                            <i class="ms-Icon ms-Icon--Upload"></i> Upload\n                        </button>\n                    </div>\n                '),h.appendChild(t)})),n.appendChild(h),document.querySelectorAll(".partner-select").forEach((function(e){e.addEventListener("change",(function(){this.closest(".partner-card").querySelector(".upload-button").style.display=this.checked?"block":"none"}))})),document.querySelectorAll(".upload-button").forEach((function(e){e.addEventListener("click",d(u().mark((function e(){var t,n,a,o,c,i,l,d;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.dataset.partnerId,n=this.innerHTML,e.prev=2,this.disabled=!0,this.innerHTML='<i class="ms-Icon ms-Icon--Sync"></i> Upload en cours...',window.attachmentsToUpload&&0!==window.attachmentsToUpload.length){e.next=8;break}return A("Aucune pièce jointe à uploader","error"),e.abrupt("return");case 8:a=new P,o=s(window.attachmentsToUpload),e.prev=10,o.s();case 12:if((c=o.n()).done){e.next=33;break}return i=c.value,e.prev=14,l=r(r({},i),{},{res_model:"res.partner",res_id:parseInt(t)}),_(i.name,"progress","Upload en cours..."),e.next=19,a.createAttachment(l);case 19:if(!(d=e.sent).success){e.next=24;break}_(i.name,"success","Upload terminé"),e.next=25;break;case 24:throw new Error(d.error||"Échec de l'upload");case 25:e.next=31;break;case 27:throw e.prev=27,e.t0=e.catch(14),_(i.name,"error",e.t0.message),e.t0;case 31:e.next=12;break;case 33:e.next=38;break;case 35:e.prev=35,e.t1=e.catch(10),o.e(e.t1);case 38:return e.prev=38,o.f(),e.finish(38);case 41:A("Pièces jointes uploadées avec succès","success"),this.closest(".partner-card").querySelector(".partner-select").checked=!1,this.style.display="none",e.next=51;break;case 48:e.prev=48,e.t2=e.catch(2),A("Erreur lors de l'upload des pièces jointes","error",{message:e.t2.message});case 51:return e.prev=51,this.disabled=!1,this.innerHTML=n,e.finish(51);case 55:case"end":return e.stop()}}),e,this,[[2,48,51,55],[10,35,38,41],[14,27]])}))))}))),e.next=24;break;case 21:e.prev=21,e.t0=e.catch(2),A("Erreur lors de la recherche","error",{message:e.t0.message});case 24:return e.prev=24,t.disabled=!1,t.innerHTML='<i class="ms-Icon ms-Icon--Search"></i>Chercher le contact',e.finish(24);case 28:case"end":return e.stop()}}),e,null,[[2,21,24,28]])})))),document.getElementById("save-to-crm").onclick=d(u().mark((function e(){var t,r,n,a,o,s,c,i,l,d,m;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(t=this).innerHTML,e.prev=2,t.disabled=!0,t.innerHTML='<i class="ms-Icon ms-Icon--Sync"></i>Création en cours...',n=document.getElementById("sender-email").value.trim(),document.getElementById("sender-name").value.trim(),a=document.getElementById("email-subject").value.trim(),o=document.getElementById("email-body").value,s=document.getElementById("additional-notes").value.trim(),n&&a){e.next=12;break}throw new Error("L'email de l'expéditeur et le sujet sont requis");case 12:return c=new P,i='<div style="font-family: Arial, sans-serif;">',i+=o.split("\n").map((function(e){return'<p style="margin: 0 0 1em 0;">'.concat(e.trim(),"</p>")})).join(""),i+="</div>",s&&(i+='<div style="margin: 30px 0;">',i+='<hr style="border: none; border-top: 1px solid #cccccc;">',i+="<h3>Notes additionnelles :</h3>",i+='<hr style="border: none; border-top: 1px solid #cccccc;">',i+=s.split("\n").map((function(e){return'<p style="margin: 0 0 1em 0;">'.concat(e.trim(),"</p>")})).join(""),i+="</div>"),e.next=19,c.createLead(n,a,i);case 19:if(!(l=e.sent).success){e.next=26;break}d=JSON.parse(localStorage.getItem("odooSettings")),m=d.odooUrl,A("Lead créé avec succès dans Odoo","success",{leadId:l.leadId,message:l.message,logs:l.details,odooUrl:m}),e.next=27;break;case 26:throw new Error("Échec de la création du lead");case 27:e.next=34;break;case 29:e.prev=29,e.t0=e.catch(2),p("Erreur complète:",e.t0),A("Erreur lors de la création du lead","error",{message:e.t0.message,type:e.t0.name,details:e.t0.details||{},logs:e.t0.logs||[],stack:e.t0.stack});case 34:return e.prev=34,t.disabled=!1,t.innerHTML=r,e.finish(34);case 38:case"end":return e.stop()}}),e,this,[[2,29,34,38]])}))),document.getElementById("save-settings").onclick=function(){var e={odooUrl:document.getElementById("odoo-url").value.trim(),database:document.getElementById("database").value.trim(),username:document.getElementById("username").value.trim(),password:document.getElementById("password").value.trim()};if(p("Sauvegarde des réglages",{hasUrl:!!e.odooUrl,hasDatabase:!!e.database,hasUsername:!!e.username,hasPassword:!!e.password}),e.odooUrl&&e.database&&e.username&&e.password)try{localStorage.setItem("odooSettings",JSON.stringify(e)),A("Réglages sauvegardés avec succès !","success")}catch(e){p("Erreur sauvegarde réglages",e),A("Erreur lors de la sauvegarde des réglages","error")}else A("Veuillez remplir tous les champs","error")}}(),function(){"use strict";new URL(r(58394),r.b)}()}();
//# sourceMappingURL=taskpane.js.map